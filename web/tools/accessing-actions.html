<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Accessing user action record</title>
</head>
<body>

<h1>Accessing user action record</h1>

<p align=center><em>Updated: 2014-09-25</em></p>

<h2>Use case</h2>
<p>Use case: <strong>... getting access to the my.arxiv logs that were
collected for implementing search ranking algorithms in Arxiv. In
particular, we are interested in the full-text logs that log the
following: Cookie-hash of user, query, rankerID that generated ranking
(either baseline, co-active perceptron, or interleaved), ranking of
docs, and clicks on the presented ranking.</strong>

<p>A sample JPQL query that retrives these data can be found at the end of this document (queries (8) and (9)). However, you may want to scan the rest of the document as well, to undertsand our data structures better.

<h2>Overview</h2>

<p>The data in question are stored in our MySQL database, accessible via this <a href="queryForm.jsp">web interface</a>. Both JPQL (recommended) and SQL queries can be used with the database. Query results can be displayed on the screen as an HTML table, or saved into a CSV file.

<p>The table <a href="manual.html#Action"><tt>Action</tt></a> contains information about all "user actions", which include, among other things, article views and article ratings. For example, whenever the user clicks to a link to an article (e.g. from a recommendation page or from a search result page), a VIEW_ABSTRACT action is recorded; whenever the user clicks on an "expang abstract" link in an article list, an EXPAND_ABSTRACT action is recorded, etc. You can find a full list of recorded action types in <a href="../doc/html/api/edu/rutgers/axs/sql/Action.Op.html">the documentation for class Action.Op</a>.

<p>Every time the system displays a list of articles to a user (e.g., when he views his recommendation list generated the previous night, or when he runs a search using My.ArXiv's own search tool), a an entry in the  <a href="manual.html#PresentedList"><tt>PresentedList</tt></a> table is generated. The PresentedList entry explains the circumstance of the list generation, and possibly referring to a DataFile object that contains information about a disk file with an entire recommendation list a section of which was presented in this PresentedList.

<h2>Action table: Listing actions</h2>

<p>Let's review some important fields of each Action record:

<ul>

<li><tt>id</tt> is assigned sequentially

<li><tt>time</tt> is the time stamp (when the action is recorded on the server)

<li>For a registered user (and only registered users receive nightly recommendation lists, such as those generated by 3PR [perturbed perceptron] or EE4), the Action entry contains an integer value in the <tt>user</tt> field. This is a user id; it can be joined with the User table for more information. (With the HTML display, you can just click on the link). I suggest that if you study activities in which only named users can engage, you make use of the <tt>user</tt> field, instead of <tt>session</tt> (see below). Joining with the User table also allows you to see what experimental plan (PPP for Thorsten's the perceptron, EE4 for Peter's Exploration-Exploitation ver. 4, etc) the user is enrolled in; this would give you an idea of what kind of recommendation list he may be shown.

<li>The <tt>session</tt> field is associated with all requests, from
both registered and anonymous users. It is an integer session ID,
equivalent to a "cookie hash". It may make sense if you study users'
interaction with My.ArXiv features that do not require logging in,
such as the session-based recommendation tool.

<li>The <tt>article</tt> field is an integer ID (internal to My.ArXiv's own database) of the article viewed or rated in the action. (Note that there are a few actions, such as REORDER, NEXT_PAGE or PREV_PAGE which have no value in this field, as they are not article-specific!). This field can be joined with the Article table to obtain the human-readable Arxiv article ID; in the HTML interface, just click on the link to view it!

<li>The <tt>op</tt> field describes the action type. (See "Overview", above).

<li>The <tt>src</tt> field is very important; it determines the type
of the "context" in which the action happened. E.g. "SB" means that
the user was viewing a session-based suggestion list (the one shown in
the small pop-up window); MAIN means that the user was viewing the
nightly recommendation list (e.g., the 3PR or EE4 type rec list in the
main window); MAIN_MIX means that the user was also viewing the
recommendation list in the main window, but the list shown to him was
an "interleaved" list, containing elements both from the 3PR (or EE4,
etc) rec list and from the baseline list (which is based on article
categories and recency).

There are many other context type; see the list in 
<a href="../doc/html/api/edu/rutgers/axs/sql/Action.Source.html">the documentation for class Action.Source</a>.

<li>The <tt>day</tt> field (only applicable for MAIN and MAIN_MIX) is mostly redundant; it distinguishes between LEARN(ing) and EVAL(uation) days. On learning days an unadulterated main-algorithm-generated list is displayed (MAIN), while on evaluation days an interleaved list is presented MAIN_MIX.

<li>The <tt>presentedListId</tt> field provides more detailed
information about the context: it identifies the specific
PresentedList which the user was viewing when he (e.g.) clicked on a
"view article" link. This allows us to join with the PresentedList table (below)...
</ul>

<h2>PresentedList table: Learning about the context</h2>

<p>A PresentedList entry looks
e.g. <a href="http://my.arxiv.org/arxiv/tools/viewPresentedList.jsp?id=6948">like
this</a>.  Like Action entries, it is also keyed to the session id and
user id, has a time stamp, and the <tt>type</tt> (from the same 
<a href="../doc/html/api/edu/rutgers/axs/sql/Action.Source.html">Action.Source</a> list).  

<p>Depending on how the list was generated, there is some additional information. In particular, a PresentedList that contain (a section of) the nightly recommendation list would have a value in the <tt>dataFileId</tt>; this links to the data file that store the complete (non-interleaved, non-paged) rec list as generated the previous night for the user in question. A  PresentedList generated in response to a search query would have a non-zero value in the <tt>queryId</tt> fields, linking to the table that stores My.ArXiv search queries.

<p>To each PresentedList entry, 10 (usually) PresentedListEntry
entries are linked. These 10 entries form an ordered list, listing the
articles presented to the user in the PresentedList. In this table,
the <tt>rank</tt> field refers to the article position in the
PresentedList (1-based). 

<h3>Interleaving</h3>
<p>When the PresentedList was generated by interleaving (the MAIN_MIX
context), the <tt>fromA</tt> field indicates that a particular article
came from the "main" list (fromA=true) or from the baseline list
(fromA=false). For each article, the rankA and rankB fields indicate
its position in the two lists being merged (interleaved).

<h2>DataFile</h2>

<p>You can view a DataFile object referred to in a PresentedList object with a query like this:
<pre>
select x from DataFile x where x.id = 27550 
</pre>
Remember that a DataFile contain the entire recommendation
list (which may be as long as 200 articles) as it was generated by the
"main" algorithm (such as 3PR aka PPP), while a PresentedList is
obtained as a result of one or two transformations:
<ol>
<li>Merging (the "team-draft" algorithm) with the baseline list
<li>Paging (the user only sees 10 article links at a time, and can navigate between pages with PREV_PAGE and NEXT_PAGE operations).
</ol>

<P>Each DataFile entry contains a <tt>type</tt> field (the value
PPP_SUGGESTIONS is for 3PR rec list files), the <tt>inputFile</tt>
field (which, in the case of 3PR rec lists, will refer to the file containing the user profile for the day in question), and the <tt>thisFile</tt> field which will refere to the actual disk file's location within the user-specific data directory, <tt>/data/arxiv/arXiv-data/user/<em>user_name</em></tt>, where <em>user_name</em> stands for the user name of the user for whom the rec list was generated.

<h3>Perturbed lists</h3>
<P>In 3PR, lists are generated by the Perturbed Perceptron process. To figure how a particular list was perturbed, you need to look first at the field DataFile.pppTopOrphan. When this flag is true, the list was broken into pairs as follows:
<pre>
 1 (2 3) (4 5) (6 7) ...
</pre>
When it falls, the breakdown is as follows:
<pre>
 (1 2) (3 4) (5 6) ...
</pre>
According to the 3PR algorithm, the perturbation process involves swapping of elements within some pairs. To find out in which pairs elements were swapped, you need to view ListEntry entries related to a particular DataFile, and compare the <tt>rank</tt> and <tt>unperturbedRank</tt> fields for each entry. Entries that have been perturbed have these two values differ. There are sample queries in the <a href="manual.html">User Guide</a>; search for the field name, <tt>unperturbedRank</tt>.

<h2>Useful JPQL queries</h2>

<p>Here are some JPQL queries that will help you explore the data.

<p>
1) View the current status (LEARN vs EVAL) for each users:

<pre>
select x.id, x.user_name, x.program, x.day from User x order by
x.program, x.day
</pre>

<p>
2) View presented lists for a particular user:

<pre>
select l from PresentedList l where l.user.user_name='vmenkov'
</pre>

<p>
Among others, you can see lists of the MAIN_SL and MAIN_MIX types,
generated on LEARN and EVAL days, respectively.  (For this particular
user for this particular day, Jan 30, you can see a logical
impossiblity - MAIN_SL and MAIN_MIX lists generated on the same day;
that's because I artificially changed the day type for this user in
the middle of this day, just so that I can write this tutorial)

<p>
You can of course also restrict the selection by date etc.

<p>
3) View the content of a particular presented list:

<pre>
select li.id, le from PresentedList li, in(li.docs) le where li.id=497
</pre>

<p>
As this was a MAIN_MIX list, its entries have 3 new columns: arank,
brank, and fromA. Here, "a" and "b" correspond to the two sources of
merging, viz. the Algo 1 list and the baseline list. The field fromA
indicates whether a particular field came from list A (i.e. the Algo 1
list).  The values arank and brank are 1-based ranks of the pages in
the two ranked lists being merged. The value of 0 means that a
particular page was not contained in a particular ranked list at all.
The column "rank", of course, is the page rank in the merged list.

<p>
4) View the user's actions' "in response" to a particular presented
list. (I.e., user's clicks on buttons within the page that
contained that list, or immediately downstream from it):

<pre>
select a from Action a where a.presentedListId=497
</pre>

<p>
5) Finally, view the actions "in response" to a particular presented
list along with the corresponding list items (i.e., you can see here
where each particular article entry in the presented list

<pre>
select a, le from Action a, PresentedList li, in(li.docs) le where
li.id=497  and li.id=a.presentedListId and a.article.aid=le.aid
</pre>

<p>
6) Naturally, you don't have to restrict to a single list: you can
select all actions for a user:

<pre>
select a, le from Action a, PresentedList li, in(li.docs) le where
li.user.user_name='vmenkov' and li.id=a.presentedListId and a.article.aid=le.aid
</pre>

<p>
7) More usefully, araankyou can select all actions for a particular user that
were effected from the MAIN_MIX environment (i.e., the user was
looking, or had been recently looking, at an interleaved list):

<pre>
select a, le from Action a, PresentedList li, in(li.docs) le where
li.user.user_name='vmenkov'  and li.id=a.presentedListId and
a.article.aid=le.aid
and a.src = edu.rutgers.axs.sql.Action$Source.MAIN_MIX
</pre>

<p>
Since the support for the "provenance" information (arank, brank) was
only added on 2013-01-30, it would make sense to also restrict the above query
by date:

<pre>
select a, le from Action a, PresentedList li, in(li.docs) le
where   li.user.user_name='vmenkov'  and li.id=a.presentedListId and a.article.aid=le.aid
and a.src = edu.rutgers.axs.sql.Action$Source.MAIN_MIX
and a.time > '2013-01-30'
</pre>

<p>8) Let's view all actions of all users enrolled in the 'PPP' program (that's Thorsten's 3PR) within a specified time:

<pre>
select a, le from Action a, PresentedList li, in(li.docs) le where li.id=a.presentedListId and a.article.aid=le.aid and a.user.program=edu.rutgers.axs.sql.User$Program.PPP and a.time > '2014-08-01' 
</pre>

<p>This more or less fits the "use case" demand:
<ul>
<li>"Cookie-hash of user" - you have the actual user ID

<li>"query" - I am not sure what "query" means in this context. Most of the contexts (MAIN, MAIN_MIX, SB) do not involve any "query" as such, as the rec list is based on the entire previous user activity. (Ever, or - for SB - during the current session).  For the SEARCH context, yes, there is a search query; contact me if you need to be shown how to get that

<li>"rankerID that generated ranking (either baseline, co-active perceptron, or interleaved),"  - since all these users are in the PPP program, the nightly rec list shown to them is either 3PR ("co-active perceptron"),  with MAIN in the "src" field, or an interleaved list ("co-active perceptron" + "baseline"), indicated by the MAIN_MIX value. There are various other contexts too, e.g. SEARCH (search with a user-entered query) or SB (session-based recommendations; contact me for details on algorithms etc, if interested)

<li>"ranking of docs": <ul>
<li><tt>rank</tt> refers to the position of the article within the final rec list (main-algorithm or interleaved, as the case may be on a given day)
<li>for interleaved lists (on EVAL days), the <tt>arank</tt> and <tt>brank</tt> fields refer to the article's position in the main-algorithm and baseline lists, respectively
<li>for interleaved lists (on EVAL days), the <tt>fromA</tt> field indicates whether the article got into the presented list from the main-algo list or the baseline list.
</ul>

<li>"clicks on the presented ranking" - Not sure what this exactly means. Perhaps the type of user action (seen in the "op" field)?

</ul>

<p>9) For saving to a CSV file, it may be convenient to somewhat reduce the number of fields reported in query (8) above. E.g. we can enter this:

<pre>
select a.id, a.user.id, a.session, a.article.aid, a.time, a.day, a.op, a.src, a.presentedListId, le.id, le.rank, le.arank, le.brank, le.fromA 
from Action a, PresentedList li, in(li.docs) le 
where li.id=a.presentedListId and a.article.aid=le.aid and a.user.program=edu.rutgers.axs.sql.User$Program.PPP 
and a.time > '2014-09-24'
</pre>

<p>
More sample JPQL queries can be found in the <a href="manual.html">user guide</a>.


</body>
</html>
